<!DOCTYPE html>
    <html>
    <head>
    <meta Access-Control-Allow-Origin: http://siteA.com >
    <meta Access-Control-Allow-Origin: *>

	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />

<img src="data:image/gif;base64,R0lGODlhEAAOALMAAOazToeHh0tLS/7LZv/0jvb29t/
f3//Ub//ge8WSLf/rhf/3kdbW1mxsbP//mf///yH5BAAAAAAALAAAAAAQAA4AAARe8L1Ekyky67
QZ1hLnjM5UUde0ECwLJoExKcppV0aCcGCmTIHEIUEqjgaORCMxIC6e0CcguWw6aFjsVMkkIr7g7
7ZKPJjPZqIyd7sJAgVGoEGv2xsBxqNgYPj/gAwXEQA7"
    width="16" height="14" alt="embedded folder icon">

    <script src="./wasmoon.js" ></script>

<script type="text/javascript">
    //js function for lua to call
    function js1( value ) {
        console.log( 'js1() ', value );
    }
</script>

<script>
luaCode = `

    print( 'LUA_VERSION ', _VERSION );

    arch = _VERSION
    if (arch or ""):match"64" then
       print"Your system is 64-bit "
       arch = arch .. ', 64-bit '
    else
       print"Your system is 32-bit "
       arch = arch .. ', 32-bit '
    end

    if( string.pack ~= nil ) then
        if #string.pack("T",0) == 4 then
            print( 'native size 32 bit' )
        end

        if #string.pack("T",0) == 8 then
            print( 'native size 64 bit' )
        end

        if #string.pack("j",0) == 4 then
            print( 'lua_Integer 32 bit' )
        end

        if #string.pack("j",0) == 8 then
            print( 'lua_Integer 64 bit' )
        end
    else
        print( 'string.pack check need lua 5.3?' );
    end

    function _86or64()
        if(0xfffffffff==0xffffffff) then return 32 else return 64 end
    end

    print( 'luacofig.h - define LUA_32BITS : ', _86or64());

function luaTest()
    print( 'lua : luaTest()' );
    window.func1( 789 );
end
`; //luaCode

async function Js2Lua() {
    try {
        lua.doString( `
            if window == nil then
                window = {};
            end

            --print( 'window', window, window.func1, window["func1"], func1 );
        `);


        <!-- await lua.global.set( 'window.func1', js1); // _G['window.func1'] -->
        <!-- lua.global.set('sum', (x, y) => x + y) -->
        <!-- lua.doString( 'print( "#1", window, window.func1, window["func1"], func1, type(window.func1) )' ); -->

        <!-- lua.global.set( "window['func1']", js1 ) // _G["window['func1']"] -->
        <!-- lua.doString( 'print( "#2", window, window.func1, window["func1"], func1 )' ); -->

        lua.global.set( 'jsFunc1', js1);
        lua.doString( 'window.func1 = jsFunc1' );
        //await lua.doString( 'window.func1(789)' );
        //lua.global.close(); // Close the lua environment, so it can be freed

        <!-- x = lua.doString( 'window.func1(789)' ); -->
        x = lua.doString( 'luaTest()' );

        // Get a global lua function as a JS function
        <!-- const multiply = lua.global.get('luaTest') -->
        <!-- console.log( luaTest(10, 10) ) -->
    } finally {
        // Close the lua environment, so it can be freed
        <!-- lua.global.close() -->
    }
}


function mainProg() {
    console.log( 'mainProg() after initWasm' );
    lua.doString( luaCode );
    Js2Lua();
} //mainProg()



async function initWasm() {
	console.log( "initWasm() start" );
    factory = new wasmoon.LuaFactory( 'glue.wasm' );
    lua = await factory.createEngine();
    mainProg();
    return 'ok';
} //initWasm()

console.log( initWasm() );



</script>

<!-- dostr -->
<!-- doscript -->
<!-- loadmodule -->
<!-- runmodule -->

function getScript(){
    //console.log( 'getScript', this.responseText );
    //console.log( 'getScript', this );
    console.log( 'getScript' );
    //console.log( this.getAllResponseHeaders() );
}
var oReq = new XMLHttpRequest();
oReq.addEventListener("load", getScript);
//oReq.open("GET", lua01.src ); //open(method,url,async,user,psw)
//https://en.wikipedia.org/wiki/List_of_HTTP_header_fields
//oReq.setRequestHeader( header, value)
//oReq.send("fname=Henry&lname=Ford"); 
//send() 	Sends the request to the server (used for GET)
//send(string) 	Sends the request to the server (used for POST)
oReq.open("GET", 'http://localhost/error' ); //open(method,url,async,user,psw)
oReq.send(); 



// ---------- ---------- ---------- ---------- ---------- 
function funcPromise1( tmpX ) {
    function myDisplayer(some) {
        console.log( 'myPromise1 -> myDisplayer', some, Date.now() );
    }

    console.log( 'myPromise1 start...', Date.now() );
    let myPromise1 = new Promise(function(myResolve1, myReject1) {
        let x = 0;
        // The producing code (this may take some time)
        // some code (try to change x to 5)
        x=tmpX;

      if (x == 0) {
        myResolve1("OK");
      } else {
        myReject1("Error");
      }
    });

    myPromise1.then(
      function(value) {myDisplayer(value);}, //myResolve1
      function(error) {myDisplayer(error);}  //myReject1
    );
} //funcPromise1();
<!-- funcPromise1(0); -->
<!-- funcPromise1(5); -->



// ---------- ---------- ---------- ---------- ---------- 
function funcPromise2() {
    console.log( 'myPromise2 start, wait 3 sec ...', Date.now() );
    let myPromise2 = new Promise(function(myResolve2, myReject2) {
      setTimeout(function(){ myResolve2("I love You !!"); }, 3000);
    });
    myPromise2.then(
        function(value) {
            console.log( 'myPromise2.then myResolve2', value, Date.now() );
        },
        function(value) {
            // never call this
            console.warn( 'myPromise2.then myReject2', value, Date.now() );
        },
    );
} //funcPromise2()
<!-- funcPromise2(); -->
// ---------- ---------- ---------- ---------- ---------- 



id = 'lua01.src';
function funcPromise3(){
    console.log( 'myPromise3 start ...', Date.now() );

    myPromise3 = new Promise(
    //function(myResolve, myReject) {
    function() {
        function checkerSuccess(response, id) {
            //console.log( 'checkerSuccess', id, response);
            console.log( 'myPromise3 - checkerSuccess', id, Date.now() );
        }
        function checkerError(error, id) {
            //console.warn( id, error);
            console.warn( 'myPromise3 - checkerError', id, Date.now() );
        }

        var xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            console.log( 'myPromise3 this.onload', this.readyState, ', this.status', this.status );
            if (this.status == 200) {
                checkerSuccess( this.responseText, id );
            } else {
                checkerError( this.responseText, id );
            }
        } //xhttp.onload = function()
        xhttp.open("GET", lua01.src, true);
        xhttp.send();
        <!-- xhttp.open("GET", 'http://localhost/error', true); -->
        <!-- xhttp.send(); -->
    } //function()
    ); //new Promise
} //funcPromise3();
<!-- funcPromise3(); -->



// ---------- ---------- ---------- ---------- ---------- 
function funcPromise4( url, myId ){
    console.log( 'myPromise4 start ...', Date.now() );

    var xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        if (this.status == 200) {
            //console.log( this.responseText, id );
            console.log( 'funcPromise4 this.onload', this.readyState, ', this.status', this.status, ' : ', myId  );
        } else {
            //console.warn( this.responseText, id );
            console.warn( 'funcPromise4 this.onload', this.readyState, ', this.status', this.status, ' : ', myId  );
        }
    } //xhttp.onload = function()

    myPromise4 = new Promise(
    function(myResolve4, myReject4) {
    //function() {
        xhttp.open("GET", url, true);
        xhttp.send();
        //myReject4( 'test2' );
        //myResolve4( 'test1' );
    } //function()
    ); //new Promise
    myPromise4.then(
      function(value) { console.log( 'myResolve4', value); }, //myResolve4
      function(error) { console.log( 'myReject4', error); }  //myReject4
    );
} //funcPromise4();

<!-- funcPromise4( 'http://localhost/Upload/100MB.bin', '100 mb' ); -->
<!-- funcPromise4( 'http://localhost/Upload/test10Mb.db.zip', '10mb' ); -->
<!-- funcPromise4( 'http://localhost/Upload/5MB.zip', '5mb' ); -->
<!-- funcPromise4( 'http://localhost/Upload/test1Mb.db.zip', '1mb' ); -->
<!-- funcPromise4( lua01.src, 'id=lua01.src' ); -->
<!-- funcPromise4( lua01.src+'x', 'id=x' ); -->


<!-- http://speedtest.ftp.otenet.gr/files/test1Mb.db -->
<!-- http://ipv4.download.thinkbroadband.com/5MB.zip -->
<!-- http://speedtest.ftp.otenet.gr/files/test10Mb.db -->
<!-- http://ipv4.download.thinkbroadband.com/20MB.zip -->
<!-- http://ipv4.download.thinkbroadband.com/50MB.zip -->
<!-- https://speed.hetzner.de/100MB.bin -->
<!-- http://ipv4.download.thinkbroadband.com/200MB.zip -->
<!-- http://ipv4.download.thinkbroadband.com/512MB.zip -->

// ---------- ---------- ---------- ---------- ---------- 
async function funcPromise5( tmpList ) {

    const promiseArray = []; // create an array for promises

    for( let file1 of tmpList ) {

        var xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
            if (this.status == 200) {
                console.log( 'funcPromise5 this.onload', this.readyState, ', this.status', this.status, ' : ', file1 );
            } else {
                console.log( 'funcPromise5 this.onload', this.readyState, ', this.status', this.status, ' : ', file1 );
            }
        } //xhttp.onload = function()

        console.log( 'funcPromise5 - file : ', file1 );
        promiseArray.push(
            new Promise( function(myResolve5, myReject5) {
                xhttp.open("GET", file1, true);
                xhttp.send();
            }
            
            ), //function / new Promise
      function(value) { console.log( 'myResolve5', value); }, //myResolve5
      function(error) { console.log( 'myReject5', error); }  //myReject5
        ); //promiseArray.push
    }
    await Promise.all(promiseArray); // wait for all the images to be loaded
    console.log("funcPromise5 - all files loaded");
} //funcPromise5()

files = [
    'http://localhost/Upload/100MB.bin',
    'http://localhost/Upload/test10Mb.db.zip',
    'http://localhost/Upload/5MB.zip',
    'http://localhost/Upload/test1Mb.db.zip',
    './01.lua.js',
    './mymodule.lua.js',
    //'not found',
];

<!-- funcPromise5( files ); -->



// ---------- ---------- ---------- ---------- ---------- 
async function funcPromise6( tmpList ) {

    const promiseArray = []; // create an array for promises

    for( let file1 of tmpList ) {
        console.log( 'funcPromise6 - file : ', file1 );
        promiseArray.push(
            new Promise( function(myResolve6, myReject6) {

        var xhttp = new XMLHttpRequest();
            xhttp.onload = function() {
                if (this.status == 200) {
                    console.log( 'funcPromise6 this.onload', this.readyState, ', this.status', this.status, ' : ', file1 );
                    myResolve6(xhttp.response);
                } else {
                    console.log( 'funcPromise6 this.onload', this.readyState, ', this.status', this.status, ' : ', file1 );
                    myReject6(Error(xhttp.statusText));
                }
            }; //xhttp.onload = function()
            xhttp.onerror = function() {
                reject(Error('funcPromise6 onerror.'));
            };
            xhttp.open("GET", file1, true);
            xhttp.send();
        }), //function / new Promise
      function(value) { console.log( 'myResolve5', value); }, //myResolve5
      function(error) { console.log( 'myReject5', error); }  //myReject5
        ); //promiseArray.push
    } //for

    await Promise.all(promiseArray); // wait for all the images to be loaded
    console.log("funcPromise6 - all files loaded");
} //funcPromise6()

files = [
    'http://localhost/Upload/100MB.bin',
    'http://localhost/Upload/test10Mb.db.zip',
    'http://localhost/Upload/5MB.zip',
    'http://localhost/Upload/test1Mb.db.zip',
    './01.lua.js',
    './mymodule.lua.js',
    //'not found',
];
<!-- funcPromise6( files ); -->



// ---------- ---------- ---------- ---------- ---------- 



// ---------- ---------- ---------- ---------- ---------- 
var se = document.createElement('script');
se.setAttribute('type', 'text/javascript');
se.appendChild(document.createTextNode('console.log("add script");'));
document.getElementsByTagName('head').item(0).appendChild(se);


async function doStr() {
    console.log( '---------- dostr Start ----------' );

    var code1 = `
    print(123);
    return 456;
    `;

    //x =  lua.doString( 'print(123); return 456;')
    //x.then( (c) => {console.log(c)}	)
    x = await lua.doString( 'print(123); return 456;')
    console.log( 'lua.doString : ', x );

    try {
        x = await lua.doString( 'assert error'); //return -1
        console.log( 'lua.doString [error code] : ', x );
    } catch(err) {
        console.log( 'error #1', err, err.message );
    }

    // x = await lua.doString( 'assert error'); // program stop if no try catch error 
    console.log( '---------- dostr Done ----------' );
} //doStr()

async function doStript() {
        console.log( '---------- doScript Start ----------' );
        <!-- lua_State *L = luaL_newstate(); -->
  <!-- luaL_openlibs(L); -->
  <!-- luaL_dofile(L, "script.lua"); -->

        <!-- await factory.mountFile('init.lua', `return 42`) -->
        <!-- const value = await engine.doFile('init.lua') -->

        <!-- expect(value).to.be.equal(42) -->
        
        await factory.mountFile( '01.lua.js', 'return 1122');
        value = await lua.doFile( '01.lua.js' );
        console.log( 'lua.doFile : ', value );

        value2 = await lua.doFile( '01.lua.js' );
        console.log( 'again ? ', value2, await lua.doFile( './01.lua.js') );

        x = await lua.doString( `
        print( '---------- Beginning of 01.lua.js ----------' )

foo = 1234;
print("[Lua] foo = ".. foo)

function _G.f01()
    print( '_G.f01 no param' )
end

function f0()
    print( 'f0 no param' )
end

function f1( a )
    print( 'f1 1 param', a )
end

function r1()
    print( 'r1 return 1 result' )
    return 123
end

function f1r1(a)
    print( 'f1r1() get 1 param, return with add 5' )
    return a+5;
end
    
print( '---------- end of file ----------' )

return 135
`);

        /*
        x = fengari.load( 'dofile("./01.lua.js") ');
        console.log( 'fengari.load () : ' );
        x();

        console.log( 'fengari.lauxlib.luaL_dofile : ' );
        fengari.lauxlib.luaL_dofile( L, fengari.to_luastring('./01.lua.js') );
        */
        console.log( '---------- doScript Done ----------' );
} //doStript()

function test01() {
    lua.doString( `
        for k,v in pairs(_G) do 
            --print(k,v) 
        end
    ` );

    lua.doString( `
        x = load( '01.lua.js' );
        print( x );
        load( 'print("123"); return 0;' )()
    ` );



    //lua.global.loadFile('./01.lua.js')
    //lua.global.loadFile('./01.lua')
    //lua.global.loadFile('./01')

//    lua.doFile('./01.lua.js');
//    lua.doFile('./01.lua');
//    lua.doFile('./01');
    /*
  lua.global.set("getObject", () => {
    return { hello: "world" };
  });

  await lua.doString(`
  obj = getObject()
  print(obj)
  `);


  engine.global.set("window", window);
  engine.global.set(
    "sleep",
    (ms) => new Promise((resolve) => setTimeout(resolve, ms))
  );
  await engine.doString(`
    window.document.write("Wait for it...")
    sleep(1000):await()
    window.document.write("Just a second...")
    sleep(1000):await()
    window.document.write("Done.")
  `);



await lua.doString(" print( os.time() ); "); await lua.doString(" print( os.time() ); ");

await lua.doString(`
for i=1,10 do print( os.time() ) end
`);




  */
}



https://github.com/ceifa/wasmoon
const { LuaFactory } = require('wasmoon')

// Initialize a new lua environment factory
// You can pass the wasm location as the first argument, useful if you are using wasmoon on a web environment and want to host the file by yourself
const factory = new LuaFactory()
// Create a standalone lua environment from the factory
const lua = await factory.createEngine()


try {
    // Set a JS function to be a global lua function
    lua.global.set('sum', (x, y) => x + y)
    // Run a lua string
    await lua.doString(`
    print(sum(10, 10))
    function multiply(x, y)
        return x * y
    end
    `)
    // Get a global lua function as a JS function
    const multiply = lua.global.get('multiply')
    console.log(multiply(10, 10))
} finally {
    // Close the lua environment, so it can be freed
    lua.global.close()
}


</script>